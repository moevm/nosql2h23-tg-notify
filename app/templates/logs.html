{% extends "base.html" %}

{% block head %}
  <title>Логи</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  <!-- зашрузим дыннне с бд -->
  <script>

    window.MAX_NUM_ROW_TABLE = 2 // максимальное количество строк в таблице
    window.curr_page = 1 // текущая страница таблицы
    window.flad_load_tables = false
    window.flag_search = false

    $.ajax({
    type: "GET",
    url: "/log/AllLogs/",
    contentType : "application/json",
    headers: {"Authorization": sessionStorage.getItem("token")},

    success: function(data) {

          window.curr_arr_tables = data; //массив всех таблиц

          console.log(data)

          
          window.flad_load_tables = true
          },

    error: function(request,status,errorThrown) {

          $("body").html(`<h2> ${errorThrown}</h2>`);

    }

    });

  </script>

{% endblock %}


{% block bar_item_4_style %} 
style= "border-bottom-color: white;
        box-sizing: border-box;
        border-bottom-width: 4px;
        border-bottom-style: solid;
        padding: 24px 26px" 
{% endblock %}



{% block content %}

  <div class=" w3-container w3-margin">
  <div class=" w3-card-4 ">
  <div class="w3-cell-row ">
    
      <div class="w3-container  w3-cell " style="width: 110px; ">
        <p  style="margin-top: 10px">Поиск по:</p>
      </div>
      
      <div class="w3-container w3-padding-24  w3-cell" style="width: 270px">
        <select class="w3-select w3-border" id="option">
          <option value="date">Дате</option>
          <option value="action">Действию</option>
          <option value="table">Таблице</option>
          <option value="admin">Пользователю</option>
        </select>
      </div>
      
      <div class="w3-container  w3-cell"  >
        <input class="w3-input w3-border" style="width: 800px;" type="text" placeholder="Введите данные" id="search_label">
      </div>
      
      <div class="w3-container w3-center w3-cell">
         <button onclick="search()" class="w3-btn w3-blue " >Поиск</button></p>
      </div>

      <div class="w3-container w3-center w3-cell">
        <button onclick="cancel()" class="w3-btn w3-gray " >Отмена</button></p>
      </div> 
      
      
      
  </div>
  </div>
  </div>

  
<div class=" w3-container  w3-margin">
  <div class=" w3-card-4 ">
  <div class="w3-bar">
  
    <div class="w3-container  w3-bar-item " >
      <p ><b>Таблица Логов</b></p>
    </div>
    
  </div>
  
  
  <div class=" w3-container">
  <table class="w3-table-all"  style="margin-bottom: 25px" id="table">
    <tr>
      <th class="w3-center">Дата</th>
      <th class="w3-center">Сообщение</th>
      <th  class="w3-center">Действие</th>
      <th  class="w3-center" >Таблица</th>
      <th  class="w3-center" >Пользователь</th>
    </tr>
    

      
    </table>


    <div class="w3-show-inline-block w3-right" style="margin-bottom: 15px">
      <div class="w3-bar w3-border " id="pagination">
      </div>
      </div>

  </div>
  
  
  </div>
  </div>







<!--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-->



<script>

window.onload = ()=> {
  var i = 0

  while (window.flad_load_tables === false && i < 1000){
    console.log("wait")
    i += 1
    setTimeout(()=> {}, 2000)
  } 

  update()
}


//window.onload = insert_table_html(1)

//вставляет пагинацию
function insert_pagination(){
  pagin_html = " <button  onclick=\"left_click()\" class=\"w3-bar-item w3-button  w3-border\">&laquo;</a>"   

  for(i = 1; i <= window.max_num_page; i++){
    pagin_html += "<button  id=\"pagn_btn_"+ i + "\" class=\"w3-bar-item w3-button \" style=\"padding: 8.8px 16px\">" + i +"</a>"
    console.log(i)
  }

  pagin_html += " <button  onclick=\"right_click()\" class=\"w3-bar-item w3-button  w3-border\" >&raquo;</a>"

  $("#pagination").html(pagin_html)

  $('#pagn_btn_1').addClass('w3-blue');

}

//вставляем строки
function  insert_table_html(n_page){
  rows_html = `<tr> 
                <th class="w3-center">Дата</th>
                <th class="w3-center">Сообщение</th>
                <th  class="w3-center">Действие</th>
                <th  class="w3-center" >Таблица</th>
                <th  class="w3-center" >Пользователь</th>
              </tr>`

  tables = window.curr_arr_tables
  M = window.MAX_NUM_ROW_TABLE

  for(i = (n_page-1) * M; i < M * n_page; i++){
    el = tables[i]

    if (i >= tables.length) {
      //создаем пустую строку
      rows_html +=`<tr>
                    <td style="height: 39.3px"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                  </tr>`
      continue;
    }

    

    if(el.admin === null){
      login = "-" } else{
        login = el.admin.login 
      }

    rows_html +=  ` <tr>
                      <td  class="w3-center" >${convert_date(el.changeDate) }</td>
                      <td  class="w3-center" >${el.message}</td>
                      <td  class="w3-center" >${el.action}</td>
                      <td  class="w3-center" >${el.table.tableName}</td> 
                      <td  class="w3-center" >${ login}</td>
                    </tr>`
  
  }

  $("#table").html(rows_html)

}

function convert_date(iso_format){
  var date = new Date(iso_format);
  var day = date.getDate(); // Get the day
  var month = date.getMonth() + 1; // Get the month
  var year = date.getFullYear(); // Get the year

  if (month < 10) {
    month = '0' + month; // Add leading 0 if the month is less than 10
  }

  if (day < 10) {
    day = '0' + day; // Add leading 0 if the day is less than 10
  }

  var formattedDate = day + "." + month + "." + year;

  return formattedDate;
}

//переход по таблице в право
function right_click() {
  if (window.curr_page >= window.max_num_page ) return;

  insert_table_html(window.curr_page + 1)
  $('#pagn_btn_'+ window.curr_page ).removeClass('w3-blue')
  $('#pagn_btn_'+ (window.curr_page+1)).addClass('w3-blue')

  window.curr_page = window.curr_page + 1
}

//переход по таблице в право
function left_click() {
  if (window.curr_page <= 1) return;

  insert_table_html(window.curr_page - 1)
  $('#pagn_btn_'+ window.curr_page ).removeClass('w3-blue')
  $('#pagn_btn_'+ (window.curr_page-1)).addClass('w3-blue')

  window.curr_page = window.curr_page - 1
}



function search(){
  var selectedValue = $('#option').val();
  var input_text = $('#search_label').val();

  if (window.flag_search === false) {
    window.copy_arr_tables =  window.curr_arr_tables.slice();
  } else {
    window.curr_arr_tables = window.copy_arr_tables.slice();
  }
  

  if (input_text === "") return;

  window.flag_search = true;

  switch (selectedValue) {
    case "date":
      func = (el) => convert_date(el.changeDate).includes(input_text);
      break;
    case "action":
      func = (el) => el.action.toLowerCase().includes(input_text.toLowerCase());
      break;
    case "table":
      func = (el) => el.table.tableName.toLowerCase().includes(input_text.toLowerCase());
      break;  
    case "admin":
      func = (el) => {var login = "-"; if (el.admin != null){login = el.admin.login}; return login.toLowerCase().includes(input_text.toLowerCase()) }; 
      break;
    default:
  }

  window.curr_arr_tables =  window.curr_arr_tables.filter(func)

  update()
}


function cancel(){
  window.curr_arr_tables = window.copy_arr_tables.slice();
  delete window.copy_arr_tables

  window.flag_search = false;

  $('#search_label').val('');

  update()
}


function update(){
  var max_len_list = window.curr_arr_tables.length 
  var max_num_page = Math.floor(max_len_list / window.MAX_NUM_ROW_TABLE)

  if(max_len_list % window.MAX_NUM_ROW_TABLE != 0){
    max_num_page = max_num_page + 1
  }

  window.max_num_page = max_num_page //максимальное  количество страниц таблицы
  insert_pagination()
  insert_table_html(1)
}

</script>

{% endblock %}
